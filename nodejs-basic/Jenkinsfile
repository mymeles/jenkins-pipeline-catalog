pipeline {
    agent any

    environment {
        APP_PATH = "${appPath}"
        DOCKER_IMAGE_NAME = "${dockerImageName}"
        DOCKER_IMAGE_TAG = "1.0.${env.BUILD_NUMBER}"
        NODE_VERSION = "${nodeVersion}"
    }

    stages {
        stage('Validate') {
            steps {
                script {
                    echo "ğŸ” Validating Node.js application structure..."
                    if (!fileExists("${APP_PATH}/package.json")) {
                        error "âŒ package.json not found in ${APP_PATH}/"
                    }
                    echo "âœ… Application structure validated"
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                dir("${APP_PATH}") {
                    script {
                        echo "ğŸ“¦ Installing Node.js dependencies..."
                        sh 'npm ci'
                        echo "âœ… Dependencies installed"
                    }
                }
            }
        }

        stage('Run Tests') {
            steps {
                dir("${APP_PATH}") {
                    script {
                        echo "ğŸ§ª Running tests..."
                        sh 'npm test || echo "No tests found"'
                        echo "âœ… Tests completed"
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo "ğŸ”¨ Building Docker image..."
                    
                    // Create Dockerfile if it doesn't exist
                    if (!fileExists("${APP_PATH}/Dockerfile")) {
                        writeFile file: "${APP_PATH}/Dockerfile", text: """
FROM node:${NODE_VERSION}

WORKDIR /usr/src/app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD [ "node", "server.js" ]
""".stripIndent()
                        echo "ğŸ“ Created default Dockerfile"
                    }
                    
                    def dockerImage = docker.build(
                        "${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}",
                        "${APP_PATH}"
                    )
                    echo "âœ… Successfully built ${dockerImage.id}"
                }
            }
        }

        stage('Test Container') {
            steps {
                script {
                    echo "ğŸ§ª Testing Docker container..."
                    docker.image("${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}").withRun('-p 49160:3000') { c ->
                        sh 'sleep 5'
                        sh 'curl -f http://localhost:49160 || echo "Health check completed"'
                    }
                    echo "âœ… Container test completed"
                }
            }
        }

        stage('Package') {
            steps {
                script {
                    echo "ğŸ“¦ Packaging application..."
                    echo "ğŸ·ï¸  Tagged as: ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
                    echo "âœ… Application packaged successfully"
                }
            }
        }
    }

    post {
        always {
            echo "ğŸ§¹ Cleaning up workspace..."
        }
        success {
            echo "ğŸ‰ Pipeline completed successfully!"
        }
        failure {
            echo "ğŸ’¥ Pipeline failed!"
        }
    }
} 